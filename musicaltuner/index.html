<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Afinador CromÃ¡tico</title>
<style>
body {
  background:#111;
  color:#eee;
  font-family:Arial, sans-serif;
  text-align:center;
}
button {
  padding:12px 20px;
  font-size:16px;
}
#note {
  font-size:72px;
}
#freq {
  font-size:20px;
}
#meter {
  width:300px;
  height:10px;
  background:#333;
  margin:10px auto;
}
#level {
  height:100%;
  width:0%;
  background:lime;
}
#needle {
  width:2px;
  height:100px;
  background:red;
  margin:20px auto;
  transform-origin:bottom center;
}
</style>
</head>
<body>

<h1>ðŸŽµ Afinador CromÃ¡tico</h1>
<button id="start">Iniciar</button>

<div id="note">â€“</div>
<div id="freq">0 Hz</div>

<div id="meter"><div id="level"></div></div>
<div id="needle"></div>

<script>
const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
let ctx, analyser;

document.getElementById("start").onclick = async () => {
  ctx = new AudioContext();

  const stream = await navigator.mediaDevices.getUserMedia({
    audio: {
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });

  const src = ctx.createMediaStreamSource(stream);

  const hp = ctx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.value = 80;

  const lp = ctx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.value = 1200;

  analyser = ctx.createAnalyser();
  analyser.fftSize = 2048;

  src.connect(hp);
  hp.connect(lp);
  lp.connect(analyser);

  update();
};

function update() {
  const buf = new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buf);

  const rms = Math.sqrt(buf.reduce((s,v)=>s+v*v,0)/buf.length);
  document.getElementById("level").style.width =
    Math.min(100, rms*300) + "%";

  const pitch = yin(buf, ctx.sampleRate);

  if (pitch > 0) {
    const midi = 69 + 12*Math.log2(pitch/440);
    const note = noteNames[Math.round(midi)%12];
    const cents = (midi - Math.round(midi))*100;

    document.getElementById("note").textContent = note;
    document.getElementById("freq").textContent = pitch.toFixed(2)+" Hz";
    document.getElementById("needle").style.transform =
      `rotate(${Math.max(-45,Math.min(45,cents))}deg)`;
  }

  requestAnimationFrame(update);
}

// YIN com limiar
function yin(buf, sr) {
  const SIZE = buf.length;
  const minTau = Math.floor(sr/1000);
  const maxTau = Math.floor(sr/80);
  let bestTau = -1;
  let bestVal = Infinity;

  for (let tau=minTau; tau<maxTau; tau++) {
    let sum = 0;
    for (let i=0; i<SIZE-tau; i++) {
      let d = buf[i]-buf[i+tau];
      sum += d*d;
    }
    if (sum < bestVal) {
      bestVal = sum;
      bestTau = tau;
    }
  }

  return bestTau>0 ? sr/bestTau : -1;
}
</script>
</body>
</html>
