<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Afinador Profissional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  background:#0b0b0b;
  color:#eee;
  font-family:Segoe UI, Arial;
  text-align:center;
  padding:20px;
}
button {
  padding:12px 28px;
  font-size:16px;
  border-radius:30px;
  border:none;
  background:#6366f1;
  color:white;
}
#note { font-size:90px; margin-top:20px }
#freq { opacity:.8 }
#status { font-size:22px; margin:10px }

.meter {
  width:260px;
  height:130px;
  margin:30px auto;
  position:relative;
  border-top:2px solid #333;
  border-radius:130px 130px 0 0;
}
.needle {
  position:absolute;
  bottom:0;
  left:50%;
  width:4px;
  height:120px;
  background:red;
  transform-origin:bottom;
  transform:translateX(-50%) rotate(0deg);
  transition:.1s;
}
.volume {
  width:260px;
  height:8px;
  background:#333;
  margin:10px auto;
  border-radius:4px;
}
.vol {
  height:100%;
  width:0%;
  background:lime;
}
</style>
</head>

<body>

<h1>ðŸŽµ Afinador</h1>
<button id="start">Iniciar</button>

<div id="note">â€“</div>
<div id="status">Aguardando som</div>
<div id="freq">0 Hz</div>

<div class="meter">
  <div class="needle" id="needle"></div>
</div>

<div class="volume"><div class="vol" id="vol"></div></div>

<script>
const notes=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const A4=440;

let ctx, analyser;

document.getElementById("start").onclick = async () => {
  document.getElementById("start").disabled=true;

  ctx = new AudioContext();

  if (ctx.state === "suspended") {
    await ctx.resume();
    console.log("AudioContext resumed");
  }

  const stream = await navigator.mediaDevices.getUserMedia({
    audio:{
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });

  const src = ctx.createMediaStreamSource(stream);

  analyser = ctx.createAnalyser();
  analyser.fftSize = 2048;

  src.connect(analyser);
  loop();
};

function loop(){
  const buf=new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buf);

  const rms=Math.sqrt(buf.reduce((s,v)=>s+v*v,0)/buf.length);
  document.getElementById("vol").style.width=Math.min(100,rms*400)+"%";

  if(rms>0.01){
    const f=yin(buf,ctx.sampleRate);
    if(f>0) display(f);
  }

  requestAnimationFrame(loop);
}

function display(freq){
  const midi=69+12*Math.log2(freq/A4);
  const m=Math.round(midi);
  const note=notes[(m%12+12)%12];
  const octave=Math.floor(m/12)-1;
  const ref=A4*Math.pow(2,(m-69)/12);
  const cents=1200*Math.log2(freq/ref);

  document.getElementById("note").textContent=note+octave;
  document.getElementById("freq").textContent=freq.toFixed(2)+" Hz";

  const c=Math.max(-50,Math.min(50,cents));
  document.getElementById("needle").style.transform=
    `translateX(-50%) rotate(${c}deg)`;

  const st=document.getElementById("status");
  if(Math.abs(c)<5){
    st.textContent="âœ” AFINADO";
    st.style.color="lime";
  } else if(c>0){
    st.textContent="AGUDO";
    st.style.color="orange";
  } else {
    st.textContent="GRAVE";
    st.style.color="orange";
  }
}

/* YIN */
function yin(buf,sr){
  const min=70,max=1500;
  const minTau=Math.floor(sr/max);
  const maxTau=Math.floor(sr/min);
  let best=-1;

  const yinBuf=new Float32Array(maxTau);
  for(let t=1;t<maxTau;t++){
    let s=0;
    for(let i=0;i<buf.length-t;i++){
      const d=buf[i]-buf[i+t];
      s+=d*d;
    }
    yinBuf[t]=s;
  }

  let run=0;
  for(let t=1;t<maxTau;t++){
    run+=yinBuf[t];
    yinBuf[t]*=t/run;
    if(t>minTau && yinBuf[t]<0.15){
      best=t; break;
    }
  }

  return best>0 ? sr/best : -1;
}
</script>
</body>
</html>
