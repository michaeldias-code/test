<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Afinador CromÃ¡tico Profissional</title>
<style>
body {
  background:#111;
  color:#eee;
  font-family:Arial, sans-serif;
  text-align:center;
}
button {
  padding:12px 20px;
  font-size:16px;
}
#note {
  font-size:72px;
}
#status {
  font-size:20px;
  margin:10px;
}
#freq {
  font-size:18px;
}
#meter {
  width:300px;
  height:10px;
  background:#333;
  margin:10px auto;
}
#level {
  height:100%;
  width:0%;
  background:lime;
}
#needle {
  width:2px;
  height:120px;
  background:red;
  margin:20px auto;
  transform-origin:bottom center;
}
</style>
</head>
<body>

<h1>ðŸŽµ Afinador CromÃ¡tico</h1>
<button id="start">Iniciar</button>

<div id="note">â€“</div>
<div id="status">â€“</div>
<div id="freq">0 Hz</div>

<div id="meter"><div id="level"></div></div>
<div id="needle"></div>

<script>
const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
let ctx, analyser;
let lastPitch = null;

document.getElementById("start").onclick = async () => {
  ctx = new AudioContext();

  const stream = await navigator.mediaDevices.getUserMedia({
    audio: {
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });

  const src = ctx.createMediaStreamSource(stream);

  const hp = ctx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.value = 70;

  const lp = ctx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.value = 1500;

  analyser = ctx.createAnalyser();
  analyser.fftSize = 2048;

  src.connect(hp);
  hp.connect(lp);
  lp.connect(analyser);

  update();
};

function update() {
  const buf = new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buf);

  const rms = Math.sqrt(buf.reduce((s,v)=>s+v*v,0)/buf.length);
  document.getElementById("level").style.width =
    Math.min(100, rms*300) + "%";

  const pitch = yin(buf, ctx.sampleRate);

  if (pitch > 0) {
    // suavizaÃ§Ã£o temporal
    lastPitch = lastPitch
      ? lastPitch*0.8 + pitch*0.2
      : pitch;

    display(lastPitch);
  }

  requestAnimationFrame(update);
}

function display(freq) {
  const midi = 69 + 12*Math.log2(freq/440);
  const note = notes[Math.round(midi)%12];
  const cents = (midi - Math.round(midi))*100;

  document.getElementById("note").textContent = note;
  document.getElementById("freq").textContent = freq.toFixed(2)+" Hz";

  const clamped = Math.max(-50,Math.min(50,cents));
  document.getElementById("needle").style.transform =
    `rotate(${clamped}deg)`;

  const status = document.getElementById("status");
  if (Math.abs(cents) < 5) {
    status.textContent = "âœ” AFINADO";
    status.style.color = "lime";
  } else {
    status.textContent = "Desvio: "+cents.toFixed(1)+" cents";
    status.style.color = "#eee";
  }
}

// YIN com CMND
function yin(buf, sr) {
  const SIZE = buf.length;
  const minFreq = 70;
  const maxFreq = 1000;
  const minTau = Math.floor(sr/maxFreq);
  const maxTau = Math.floor(sr/minFreq);

  let yinBuf = new Float32Array(maxTau);
  for (let tau=1; tau<maxTau; tau++) {
    let sum = 0;
    for (let i=0; i<SIZE-tau; i++) {
      let d = buf[i]-buf[i+tau];
      sum += d*d;
    }
    yinBuf[tau] = sum;
  }

  let runningSum = 0;
  for (let tau=1; tau<maxTau; tau++) {
    runningSum += yinBuf[tau];
    yinBuf[tau] *= tau / runningSum;
  }

  const threshold = 0.15;
  for (let tau=minTau; tau<maxTau; tau++) {
    if (yinBuf[tau] < threshold) {
      return sr / tau;
    }
  }
  return -1;
}
</script>
</body>
</html>
