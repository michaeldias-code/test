<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrônomo Profissional</title>
    <style>
        /* --- CSS Responsivo Mobile-First --- */
        :root {
            --cor-principal: #007bff;
            --cor-fundo: #f4f7f6;
            --cor-texto: #333;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .metronome-container {
            background-color: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 400px; /* Largura máxima para desktop */
            text-align: center;
        }

        h1 {
            color: var(--cor-principal);
            margin-bottom: 25px;
            font-size: 1.8rem;
        }

        /* BPM Display */
        .bpm-display {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 20px;
            height: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Controles de BPM (Responsivos) */
        .bpm-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 30px;
        }

        .bpm-controls button {
            background-color: var(--cor-principal);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px; /* Grande o suficiente para toque */
            height: 60px;
            font-size: 2rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-shrink: 0; /* Não permite que os botões diminuam */
        }

        .bpm-controls button:active {
            transform: scale(0.95);
        }

        .bpm-slider-container {
            width: 100%;
            margin-bottom: 20px;
        }

        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            background: #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--cor-principal);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        
        /* Botão Play/Stop */
        #playStopBtn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            width: 100%;
            max-width: 250px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        #playStopBtn.playing {
            background-color: #dc3545;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        #playStopBtn:active {
            transform: scale(0.98);
        }

        /* Indicador Visual da Batida */
        .beat-indicator {
            width: 25px;
            height: 25px;
            background-color: #e9ecef;
            border-radius: 50%;
            margin: 10px auto;
            transition: background-color 0.1s;
        }

        .beat-indicator.active {
            background-color: #ffc107;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.8);
        }

    </style>
</head>
<body>

    <div class="metronome-container">
        <h1>Metrônomo Profissional</h1>
        
        <div class="beat-indicator" id="beatIndicator"></div>

        <div class="bpm-display" id="bpmDisplay">120</div>

        <div class="bpm-controls">
            <button id="decreaseBPM">-</button>
            <div class="bpm-slider-container">
                <input type="range" id="bpmSlider" min="40" max="240" value="120">
            </div>
            <button id="increaseBPM">+</button>
        </div>
        
        <button id="playStopBtn">Iniciar</button>
    </div>

    <script>
        // --- JavaScript (Web Audio API) ---

        let isRunning = false;
        let bpm = 120;
        let tempo = 4; // Quaternário (4/4)
        let beatsPerMeasure = tempo; // Exemplo: 4 batidas por compasso
        let currentBeat = 0;
        
        // --- Web Audio API Setup ---
        // Cria o AudioContext global. Precisa ser iniciado após um gesto do usuário.
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioContext = null;
        
        // Metrônomo Timing
        let timerWorker = null;
        let lookahead = 25.0; // Em ms. Quão longe no futuro agendamos (pequeno!)
        let scheduleAheadTime = 0.1; // Em segundos. Quão longe agendamos (maior!)
        let nextNoteTime = 0.0; // Ponto de tempo da próxima nota
        let noteResolution = 0; // 0 = 1/4 (batida), 1 = 1/8, 2 = 1/16

        // Elementos do DOM
        const bpmDisplay = document.getElementById('bpmDisplay');
        const bpmSlider = document.getElementById('bpmSlider');
        const playStopBtn = document.getElementById('playStopBtn');
        const beatIndicator = document.getElementById('beatIndicator');

        // --- Funções de Som ---

        /**
         * Cria um som de click usando um Oscillator (onda quadrada).
         * @param {number} time - O tempo exato do AudioContext para tocar a nota.
         * @param {number} frequency - A frequência da nota (Hz).
         */
        function playSound(time, frequency) {
            if (!audioContext) return;
            
            // 1. Cria o nó de volume (GainNode)
            const gainNode = audioContext.createGain();
            
            // 2. Cria o nó oscilador (som)
            const oscillator = audioContext.createOscillator();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // Ajusta a frequência e o volume
            oscillator.type = 'square'; // Som digital, claro
            oscillator.frequency.setValueAtTime(frequency, time);
            
            // Controle de volume (Envelope ADSR básico)
            gainNode.gain.setValueAtTime(0.0001, time); // Volume inicial muito baixo
            gainNode.gain.exponentialRampToValueAtTime(0.5, time + 0.01); // Ataque rápido para 50%
            gainNode.gain.exponentialRampToValueAtTime(0.0001, time + 0.05); // Decay rápido para terminar o som

            // Inicia e para o som
            oscillator.start(time);
            oscillator.stop(time + 0.05); // Duração muito curta para um click
            
            // Limpeza
            oscillator.onended = () => {
                oscillator.disconnect();
                gainNode.disconnect();
            };
        }

        /**
         * Calcula o tempo da próxima nota e agenda o som.
         */
        function scheduler() {
            // Enquanto o tempo da próxima nota for menor que o tempo atual + tempo de agendamento (scheduleAheadTime)...
            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                
                // Calcula qual é a batida atual (1, 2, 3, ou 4 do compasso 4/4)
                currentBeat = (currentBeat % beatsPerMeasure) + 1;

                let frequency = 440; // Batida normal (A4)
                if (currentBeat === 1) {
                    frequency = 880; // Batida forte (Oitava acima)
                }

                // Agenda o som no AudioContext
                playSound(nextNoteTime, frequency);
                
                // Calcula o tempo do próximo intervalo
                const secondsPerBeat = 60.0 / bpm;
                nextNoteTime += secondsPerBeat;
            }
        }
        
        /**
         * Loop principal do timer usando um Web Worker para precisão.
         */
        function startTimer() {
             // Cria um Web Worker para evitar bloqueio do thread principal
            timerWorker = new Worker(URL.createObjectURL(new Blob([
                "self.onmessage = function(e) { " +
                "  if (e.data === 'start') { " +
                "    let timerID = setInterval(() => self.postMessage('tick'), " + lookahead + "); " +
                "    self.postMessage({ type: 'timerID', id: timerID }); " +
                "  } else if (e.data === 'stop') { " +
                "    clearInterval(e.data.id); " +
                "  } " +
                "};"
            ], { type: 'application/javascript' })));

            timerWorker.onmessage = (e) => {
                if (e.data === 'tick') {
                    // O worker nos diz que é hora de agendar mais notas
                    scheduler();
                }
            };
            
            // Inicia o timer
            timerWorker.postMessage('start');
        }

        function stopTimer() {
            if (timerWorker) {
                timerWorker.terminate();
                timerWorker = null;
            }
            // Garante que o indicador pare de piscar
            beatIndicator.classList.remove('active');
        }

        // --- Funções de Controle e UI ---

        /**
         * Inicia/Para o Metrônomo
         */
        function togglePlayStop() {
            if (!audioContext) {
                 // Cria o AudioContext ao primeiro gesto do usuário
                audioContext = new AudioContext();
            }

            if (isRunning) {
                // Parar
                isRunning = false;
                stopTimer();
                playStopBtn.textContent = 'Iniciar';
                playStopBtn.classList.remove('playing');
                // Parar a animação do indicador
                clearInterval(animationInterval);
            } else {
                // Iniciar
                isRunning = true;
                currentBeat = 0; // Reseta a batida
                
                // Inicializa o tempo da próxima nota no *agora* do AudioContext
                nextNoteTime = audioContext.currentTime; 

                startTimer();
                playStopBtn.textContent = 'Parar';
                playStopBtn.classList.add('playing');
                // Inicia a animação do indicador
                startBeatAnimation();
            }
        }

        /**
         * Atualiza o BPM a partir do Slider/Controles
         * @param {number} newBPM - O novo valor de BPM.
         */
        function updateBPM(newBPM) {
            bpm = Math.max(40, Math.min(240, newBPM)); // Limita entre 40 e 240
            bpmDisplay.textContent = bpm;
            bpmSlider.value = bpm;
        }

        // --- Animação Visual ---
        let animationInterval;
        
        /**
         * Sincroniza a animação do indicador visual com a batida.
         */
        function startBeatAnimation() {
            const beatIntervalMs = (60 / bpm) * 1000;
            
            // Limpa qualquer intervalo anterior
            clearInterval(animationInterval);

            // Usa setTimeout para a primeira batida e, em seguida, setInterval
            function triggerBeat() {
                beatIndicator.classList.add('active');
                setTimeout(() => {
                    beatIndicator.classList.remove('active');
                }, 50); // Duração da animação (curta e responsiva)
            }

            // Garante que a primeira batida seja instantânea
            triggerBeat();

            // Seta o intervalo baseado no BPM atual
            animationInterval = setInterval(triggerBeat, beatIntervalMs);
        }

        // --- Event Listeners ---

        playStopBtn.addEventListener('click', togglePlayStop);
        
        bpmSlider.addEventListener('input', (e) => {
            updateBPM(parseInt(e.target.value));
            if (isRunning) {
                // Reinicia a animação se o BPM mudar
                startBeatAnimation(); 
            }
        });
        
        document.getElementById('increaseBPM').addEventListener('click', () => {
            updateBPM(bpm + 1);
            if (isRunning) {
                startBeatAnimation();
            }
        });
        
        document.getElementById('decreaseBPM').addEventListener('click', () => {
            updateBPM(bpm - 1);
            if (isRunning) {
                startBeatAnimation();
            }
        });

        // Inicializa o BPM
        updateBPM(120);

    </script>
</body>
</html>
