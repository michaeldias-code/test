<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrônomo Profissional JS</title>
    <style>
        /* --- CSS Responsivo & Profissional (Dark Theme) --- */
        :root {
            --cor-principal: #3a86ff; /* Azul vibrante */
            --cor-fundo: #1c1c1e; /* Fundo escuro */
            --cor-card: #2c2c2e; /* Fundo do container */
            --cor-texto: #f0f0f0;
            --cor-acento: #ffc400; /* Amarelo para destaque */
            --cor-acento-forte: #ff0054; /* Vermelho/Rosa para a primeira batida */
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .metronome-container {
            background-color: var(--cor-card);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            padding: 30px 20px;
            width: 100%;
            max-width: 420px; 
            text-align: center;
            border: 1px solid #444;
        }

        h1 {
            color: var(--cor-principal);
            margin-bottom: 25px;
            font-size: 1.6rem;
            letter-spacing: 1px;
        }

        /* BPM Display */
        .bpm-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        
        #bpmDisplay {
            font-size: 5.5rem; /* Maior para celular */
            font-weight: 700;
            color: var(--cor-texto);
            line-height: 1;
        }
        
        .bpm-label {
            font-size: 1rem;
            color: #aaa;
            margin-top: -10px;
        }

        /* Controles de BPM (Responsivos) */
        .bpm-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 0 5px;
        }

        .control-btn {
            background-color: var(--cor-principal);
            color: white;
            border: none;
            border-radius: 10px;
            width: 50px; 
            height: 50px;
            font-size: 1.8rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        /* Slider */
        input[type="range"] {
            width: 65%; /* Ocupa a maior parte do espaço */
            -webkit-appearance: none;
            height: 8px;
            background: #444;
            border-radius: 5px;
            margin: 0 15px;
            cursor: grab;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--cor-principal);
            cursor: grab;
            border: 3px solid var(--cor-card);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        /* Botão Play/Stop */
        .action-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px 30px;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            width: 100%;
            max-width: 300px;
            margin-top: 25px;
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
            letter-spacing: 1px;
        }

        .action-btn.playing {
            background-color: var(--cor-acento-forte); /* Muda para cor de parar */
            box-shadow: 0 5px 20px rgba(255, 0, 84, 0.4);
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        /* Indicadores Visuais de Batida */
        .beat-indicators {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            min-height: 25px; /* Para evitar saltos de layout */
        }
        
        .beat-indicator {
            width: 15px;
            height: 15px;
            background-color: #444; /* Cor inativa */
            border-radius: 50%;
            margin: 0 8px;
            transition: background-color 0.05s, transform 0.05s;
        }

        .beat-indicator.active {
            background-color: var(--cor-acento);
            transform: scale(1.3);
        }
        
        /* Destaque para a primeira batida */
        .beat-indicator:first-child.active {
            background-color: var(--cor-acento-forte); 
            box-shadow: 0 0 10px var(--cor-acento-forte);
        }

        /* Controles de Compasso */
        .time-signature-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
        }

        .control-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-right: 15px;
            flex-basis: 100%; /* Ocupa linha inteira no mobile */
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .time-sig-btn {
            background-color: #444;
            color: var(--cor-texto);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            margin: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .time-sig-btn.active {
            background-color: var(--cor-principal);
            color: white;
            font-weight: bold;
        }

        /* Media Query para telas maiores (Desktop) */
        @media (min-width: 600px) {
            .metronome-container {
                padding: 40px;
            }
            .control-label {
                flex-basis: auto;
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>

    <div class="metronome-container">
        <h1>Metrônomo PRO JS</h1>
        
        <div class="beat-indicators" id="beatIndicators">
            </div>

        <div class="bpm-display">
            <span id="bpmDisplay">120</span>
            <span class="bpm-label">BPM</span>
        </div>

        <div class="bpm-controls">
            <button id="decreaseBPM" class="control-btn">-</button>
            <input type="range" id="bpmSlider" min="40" max="240" value="120">
            <button id="increaseBPM" class="control-btn">+</button>
        </div>
        
        <div class="time-signature-controls" id="timeSignatureControls">
            <span class="control-label">COMPASSO:</span>
            <button data-beats="4" class="time-sig-btn active">4/4</button>
            <button data-beats="3" class="time-sig-btn">3/4</button>
            <button data-beats="2" class="time-sig-btn">2/4</button>
            <button data-beats="6" class="time-sig-btn">6/8</button>
        </div>

        <button id="playStopBtn" class="action-btn">INICIAR</button>
    </div>

    <script>
        // --- JavaScript (Web Audio API) para Timing Preciso ---

        let isRunning = false;
        let bpm = 120;
        let beatsPerMeasure = 4; // Padrão: 4/4
        let currentBeat = 0; // Batida atual (1 a beatsPerMeasure)
        
        // --- Web Audio API Setup ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioContext = null;
        
        // Metrônomo Timing
        let timerWorker = null;
        const lookahead = 25.0; // Em ms. Quão longe no futuro agendamos
        const scheduleAheadTime = 0.1; // Em segundos. Quão longe agendamos
        let nextNoteTime = 0.0; // Ponto de tempo da próxima nota

        // Elementos do DOM
        const bpmDisplay = document.getElementById('bpmDisplay');
        const bpmSlider = document.getElementById('bpmSlider');
        const playStopBtn = document.getElementById('playStopBtn');
        const beatIndicatorsContainer = document.getElementById('beatIndicators');
        const timeSignatureControls = document.getElementById('timeSignatureControls');

        // --- Funções de Som ---

        /**
         * Cria um som de click usando um Oscillator.
         * @param {number} time - O tempo exato do AudioContext.
         * @param {number} frequency - A frequência da nota (Hz).
         */
        function playSound(time, frequency) {
            if (!audioContext) return;
            
            const gainNode = audioContext.createGain();
            const oscillator = audioContext.createOscillator();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine'; // Som mais suave/profissional
            oscillator.frequency.setValueAtTime(frequency, time);
            
            // Envelope ADSR básico para o click
            gainNode.gain.setValueAtTime(0.0001, time);
            gainNode.gain.exponentialRampToValueAtTime(0.5, time + 0.005);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, time + 0.03); 

            oscillator.start(time);
            oscillator.stop(time + 0.03); 
            
            oscillator.onended = () => {
                oscillator.disconnect();
                gainNode.disconnect();
            };
        }

        /**
         * Calcula o tempo da próxima nota e agenda o som.
         */
        function scheduler() {
            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                
                // Calcula qual é a próxima batida
                currentBeat = (currentBeat % beatsPerMeasure) + 1;

                let frequency;
                // A primeira batida (batida forte/acento) tem uma frequência mais alta
                if (currentBeat === 1) {
                    frequency = 880; 
                } else {
                    frequency = 440; 
                }

                // Agenda o som no AudioContext
                playSound(nextNoteTime, frequency);
                
                // Agenda a animação visual para coincidir com o som
                scheduleAnimation(nextNoteTime, currentBeat);
                
                // Calcula o tempo do próximo intervalo (60 segundos / BPM)
                const secondsPerBeat = 60.0 / bpm;
                nextNoteTime += secondsPerBeat;
            }
        }
        
        /**
         * Inicializa o loop de timer em um Web Worker para precisão.
         */
        function startTimer() {
             // Worker para o loop de lookahead
             timerWorker = new Worker(URL.createObjectURL(new Blob([
                `self.onmessage = function(e) { 
                    if (e.data.command === 'start') { 
                        // Envia 'tick' a cada lookahead ms
                        let timerID = setInterval(() => self.postMessage('tick'), e.data.lookahead); 
                        self.postMessage({ type: 'timerID', id: timerID }); 
                    } else if (e.data.command === 'stop') { 
                        clearInterval(e.data.id); 
                    } 
                };`
            ], { type: 'application/javascript' })));

            timerWorker.onmessage = (e) => {
                if (e.data === 'tick') {
                    scheduler();
                }
            };
            
            timerWorker.postMessage({ command: 'start', lookahead: lookahead });
        }

        function stopTimer() {
            if (timerWorker) {
                timerWorker.terminate();
                timerWorker = null;
            }
            // Limpa o estado visual ao parar
            document.querySelectorAll('.beat-indicator').forEach(el => el.classList.remove('active'));
        }

        // --- Funções de UI e Opções ---

        /**
         * Gera os indicadores visuais (pontos) com base no número de batidas.
         */
        function generateBeatIndicators() {
            beatIndicatorsContainer.innerHTML = ''; // Limpa os antigos
            for (let i = 0; i < beatsPerMeasure; i++) {
                const dot = document.createElement('div');
                dot.classList.add('beat-indicator');
                beatIndicatorsContainer.appendChild(dot);
            }
        }

        /**
         * Agenda a mudança visual do indicador para coincidir com o som.
         * @param {number} time - O tempo exato do AudioContext para a mudança.
         * @param {number} beatIndex - O índice da batida (1 a N).
         */
        function scheduleAnimation(time, beatIndex) {
            const delay = Math.max(0, time - audioContext.currentTime);
            const indicators = document.querySelectorAll('.beat-indicator');

            setTimeout(() => {
                // Remove a classe 'active' de todos
                indicators.forEach(el => el.classList.remove('active'));
                
                // Adiciona a classe 'active' apenas ao indicador correto
                // (beatIndex - 1) porque o beatIndex é 1-baseado e o array é 0-baseado
                if (indicators[beatIndex - 1]) {
                    indicators[beatIndex - 1].classList.add('active');
                }
            }, delay * 1000); // Converte segundos para milissegundos
        }

        /**
         * Inicia/Para o Metrônomo
         */
        function togglePlayStop() {
            if (!audioContext) {
                 // Cria o AudioContext ao primeiro gesto do usuário
                audioContext = new AudioContext();
            }

            // Garante que o contexto de áudio esteja rodando
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (isRunning) {
                // Parar
                isRunning = false;
                stopTimer();
                playStopBtn.textContent = 'INICIAR';
                playStopBtn.classList.remove('playing');
            } else {
                // Iniciar
                isRunning = true;
                currentBeat = 0; // Reseta a batida
                
                // Inicializa o tempo da próxima nota no *agora* do AudioContext
                nextNoteTime = audioContext.currentTime; 

                startTimer();
                playStopBtn.textContent = 'PARAR';
                playStopBtn.classList.add('playing');
            }
        }

        /**
         * Atualiza o BPM a partir do Slider/Controles
         * @param {number} newBPM - O novo valor de BPM.
         */
        function updateBPM(newBPM) {
            bpm = Math.max(40, Math.min(240, newBPM)); // Limita entre 40 e 240
            bpmDisplay.textContent = bpm;
            bpmSlider.value = bpm;

            // Se o metrônomo estiver rodando, precisamos resetar o timer para o novo tempo ser preciso
            if (isRunning) {
                // A próxima batida será calculada no próximo 'tick' do scheduler
            }
        }
        
        // --- Event Listeners ---

        // Iniciar/Parar
        playStopBtn.addEventListener('click', togglePlayStop);
        
        // Slider e Botões de BPM
        bpmSlider.addEventListener('input', (e) => {
            updateBPM(parseInt(e.target.value));
        });
        
        document.getElementById('increaseBPM').addEventListener('click', () => updateBPM(bpm + 1));
        document.getElementById('decreaseBPM').addEventListener('click', () => updateBPM(bpm - 1));

        // Seleção de Compasso
        timeSignatureControls.addEventListener('click', (e) => {
            const button = e.target.closest('.time-sig-btn');
            if (button) {
                // Desativa todos os botões
                document.querySelectorAll('.time-sig-btn').forEach(btn => btn.classList.remove('active'));
                
                // Ativa o botão clicado
                button.classList.add('active');

                // Atualiza o número de batidas e os indicadores
                beatsPerMeasure = parseInt(button.dataset.beats);
                generateBeatIndicators();
                
                // Se estiver rodando, reinicia o ciclo para o novo compasso
                if (isRunning) {
                    currentBeat = 0;
                    // O timer continuará a rodar, mas o 'currentBeat' será resetado
                }
            }
        });


        // --- Inicialização ---

        // 1. Define o BPM inicial
        updateBPM(120);

        // 2. Cria os indicadores visuais para o compasso padrão (4/4)
        generateBeatIndicators();

    </script>
</body>
</html>
