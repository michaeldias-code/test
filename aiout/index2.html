<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrônomo Profissional com Pêndulo</title>
    <style>
        /* --- CSS Responsivo & Profissional (Dark Theme) --- */
        :root {
            --cor-principal: #3a86ff; 
            --cor-fundo: #1c1c1e; 
            --cor-card: #2c2c2e; 
            --cor-texto: #f0f0f0;
            --cor-acento: #ffc400; 
            --cor-acento-forte: #ff0054; 
            --agulha-cor: #808080;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .metronome-container {
            background-color: var(--cor-card);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            padding: 20px;
            width: 100%;
            max-width: 420px; 
            text-align: center;
            border: 1px solid #444;
        }

        h1 {
            color: var(--cor-principal);
            margin-bottom: 25px;
            font-size: 1.6rem;
            letter-spacing: 1px;
        }
        
        /* Pêndulo Visual */
        .pendulum-area {
            height: 150px;
            width: 100%;
            position: relative;
            margin-bottom: 20px;
            overflow: hidden; /* Garante que a agulha não saia da área */
        }
        
        .pendulum {
            width: 5px;
            height: 140px;
            background-color: var(--agulha-cor);
            position: absolute;
            bottom: 0;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(0deg); /* Posição inicial: centro */
            transition: transform 0.05s ease-out; /* Transição suave */
            border-radius: 5px 5px 0 0;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        
        .pendulum-base {
            width: 20px;
            height: 20px;
            background-color: var(--cor-principal);
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        /* Indicadores Visuais de Batida */
        .beat-indicators {
            display: flex;
            justify-content: center;
            margin-top: 5px;
            margin-bottom: 15px;
            min-height: 25px;
        }
        
        .beat-indicator {
            width: 15px;
            height: 15px;
            background-color: #444; 
            border-radius: 50%;
            margin: 0 8px;
            transition: background-color 0.05s, transform 0.05s;
        }

        .beat-indicator.active {
            background-color: var(--cor-acento);
            transform: scale(1.3);
        }
        
        .beat-indicator:first-child.active {
            background-color: var(--cor-acento-forte); 
            box-shadow: 0 0 10px var(--cor-acento-forte);
        }

        /* Display e Controles de BPM (Mesmos da v2.0) */
        .bpm-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        #bpmDisplay {
            font-size: 4.5rem; 
            font-weight: 700;
            color: var(--cor-texto);
            line-height: 1;
        }
        
        .bpm-label {
            font-size: 1rem;
            color: #aaa;
            margin-top: -5px;
        }

        .bpm-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 0 5px;
        }

        .control-btn {
            background-color: var(--cor-principal);
            color: white;
            border: none;
            border-radius: 10px;
            width: 45px; 
            height: 45px;
            font-size: 1.6rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            flex-shrink: 0;
        }

        input[type="range"] {
            width: 65%;
            -webkit-appearance: none;
            height: 8px;
            background: #444;
            border-radius: 5px;
            margin: 0 15px;
            cursor: grab;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--cor-principal);
            cursor: grab;
            border: 3px solid var(--cor-card);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* Controles de Compasso (Time Signature) */
        .time-signature-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            border-top: 1px solid #444;
            margin-bottom: 20px;
        }

        .control-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-right: 15px;
            flex-basis: 100%; 
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .time-sig-btn {
            background-color: #444;
            color: var(--cor-texto);
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            margin: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .time-sig-btn.active {
            background-color: var(--cor-principal);
            color: white;
            font-weight: bold;
        }

        /* Botão Play/Stop */
        .action-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }

        .action-btn.playing {
            background-color: var(--cor-acento-forte); 
        }

    </style>
</head>
<body>

    <div class="metronome-container">
        <h1>Metrônomo PRO</h1>

        <div class="pendulum-area">
            <div class="pendulum" id="pendulum"></div>
            <div class="pendulum-base"></div>
        </div>
        
        <div class="beat-indicators" id="beatIndicators">
            </div>

        <div class="bpm-display">
            <span id="bpmDisplay">120</span>
            <span class="bpm-label">BPM</span>
        </div>

        <div class="bpm-controls">
            <button id="decreaseBPM" class="control-btn">-</button>
            <input type="range" id="bpmSlider" min="40" max="240" value="120">
            <button id="increaseBPM" class="control-btn">+</button>
        </div>
        
        <div class="time-signature-controls" id="timeSignatureControls">
            <span class="control-label">COMPASSO:</span>
            <button data-beats="4" data-subdivision="1" class="time-sig-btn active">4/4</button>
            <button data-beats="3" data-subdivision="1" class="time-sig-btn">3/4</button>
            <button data-beats="2" data-subdivision="1" class="time-sig-btn">2/4</button>
            <button data-beats="2" data-subdivision="3" class="time-sig-btn">6/8</button> 
            </div>

        <button id="playStopBtn" class="action-btn">INICIAR</button>
    </div>

    <script>
        // --- JavaScript (Web Audio API) e Lógica de Pêndulo ---

        let isRunning = false;
        let bpm = 120;
        let beatsPerMeasure = 4;      // Número de batidas fortes (numerador)
        let subdivisionFactor = 1;    // 1: Sem subdivisão (simples), 3: Triplete (composto)
        let totalBeats = beatsPerMeasure * subdivisionFactor; // Total de cliques por ciclo
        let currentClick = 0;         // O índice atual do clique (1 a totalBeats)
        
        // --- Web Audio API Setup ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioContext = null;
        
        let timerWorker = null;
        const lookahead = 25.0; 
        const scheduleAheadTime = 0.1; 
        let nextNoteTime = 0.0; 
        
        // Elementos do DOM
        const bpmDisplay = document.getElementById('bpmDisplay');
        const bpmSlider = document.getElementById('bpmSlider');
        const playStopBtn = document.getElementById('playStopBtn');
        const beatIndicatorsContainer = document.getElementById('beatIndicators');
        const timeSignatureControls = document.getElementById('timeSignatureControls');
        const pendulumEl = document.getElementById('pendulum');
        
        // Variáveis do Pêndulo
        let isMovingRight = true; // Controla o sentido do movimento da agulha

        // --- Funções de Som ---

        /**
         * Cria e toca um som curto e preciso.
         * @param {number} time - O tempo exato do AudioContext.
         * @param {number} frequency - A frequência da nota (Hz).
         * @param {number} volume - O volume máximo (0.0 a 1.0).
         */
        function playSound(time, frequency, volume) {
            if (!audioContext) return;
            
            const gainNode = audioContext.createGain();
            const oscillator = audioContext.createOscillator();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'square'; // Usando square para um click mais definido
            oscillator.frequency.setValueAtTime(frequency, time);
            
            // Envelope ADSR básico
            gainNode.gain.setValueAtTime(0.0001, time);
            gainNode.gain.exponentialRampToValueAtTime(volume, time + 0.005);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, time + 0.03); 

            oscillator.start(time);
            oscillator.stop(time + 0.03); 
            
            oscillator.onended = () => {
                oscillator.disconnect();
                gainNode.disconnect();
            };
        }

        /**
         * Calcula o tempo da próxima nota e agenda o som.
         */
        function scheduler() {
            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                
                // 1. Calcula o próximo clique (1 a totalBeats)
                currentClick = (currentClick % totalBeats) + 1;

                let frequency = 440; // Default (Subdivisão)
                let volume = 0.3;
                
                // Verifica se o clique é o Downbeat (Primeira batida do compasso)
                if (currentClick === 1) {
                    frequency = 880; // Mais alto para o Downbeat
                    volume = 0.7;
                } 
                // Verifica se é uma batida principal, mas não o Downbeat (ex: 2, 3, 4 em 4/4)
                else if (subdivisionFactor === 1 || (currentClick - 1) % subdivisionFactor === 0) {
                    frequency = 660; // Médio para as batidas principais
                    volume = 0.5;
                }
                // Outros cliques são as subdivisões
                else {
                    // frequency = 440;
                    // volume = 0.3; (Já definido acima)
                }

                // 2. Agenda o som
                playSound(nextNoteTime, frequency, volume);
                
                // 3. Agenda a animação visual (indicador de ponto e pêndulo)
                scheduleAnimation(nextNoteTime, currentClick);
                
                // 4. Calcula o tempo do próximo clique
                // O intervalo é baseado no BPM e na subdivisão
                const secondsPerClick = (60.0 / bpm) / subdivisionFactor;
                nextNoteTime += secondsPerClick;
            }
        }
        
        /**
         * Inicializa o loop de timer em um Web Worker.
         */
        function startTimer() {
             timerWorker = new Worker(URL.createObjectURL(new Blob([
                `self.onmessage = function(e) { 
                    if (e.data.command === 'start') { 
                        let timerID = setInterval(() => self.postMessage('tick'), e.data.lookahead); 
                        self.postMessage({ type: 'timerID', id: timerID }); 
                    } 
                };`
            ], { type: 'application/javascript' })));

            timerWorker.onmessage = (e) => {
                if (e.data === 'tick') {
                    scheduler();
                }
            };
            
            timerWorker.postMessage({ command: 'start', lookahead: lookahead });
        }

        function stopTimer() {
            if (timerWorker) {
                timerWorker.terminate();
                timerWorker = null;
            }
            document.querySelectorAll('.beat-indicator').forEach(el => el.classList.remove('active'));
            // Reseta a agulha para o centro
            pendulumEl.style.transform = 'translateX(-50%) rotate(0deg)';
        }

        // --- Animação Visual (Pêndulo e Pontos) ---

        /**
         * Move a agulha do pêndulo e atualiza os pontos visuais.
         */
        function movePendulum(clickIndex) {
            // 1. ANIMAÇÃO DE PONTOS
            const indicators = document.querySelectorAll('.beat-indicator');
            // Calcula qual batida principal estamos (1 a beatsPerMeasure)
            const beatIndex = Math.ceil(clickIndex / subdivisionFactor); 
            
            indicators.forEach(el => el.classList.remove('active'));
            if (indicators[beatIndex - 1]) {
                indicators[beatIndex - 1].classList.add('active');
            }

            // 2. ANIMAÇÃO DA AGULHA (PÊNDULO)
            
            // O pêndulo deve atingir o ponto máximo (extremo) na primeira e na última batida principal.
            // Ex: 4/4 (1, 2, 3, 4) -> Extremo L (1), Centro (2), Extremo D (3), Centro (4)
            // Ex: 6/8 (1, 2) -> Extremo L (1), Extremo D (2)
            
            // Verifica se este clique é uma batida principal (não uma subdivisão interna)
            const isMainBeat = (clickIndex === 1 || (clickIndex - 1) % subdivisionFactor === 0);

            if (isMainBeat) {
                let angle;
                
                // Pêndulo move-se de Extremo Esquerdo (-20°) para Extremo Direito (+20°) e vice-versa
                if (isMovingRight) {
                    angle = 20; // Extremo Direito
                } else {
                    angle = -20; // Extremo Esquerdo
                }

                pendulumEl.style.transform = `translateX(-50%) rotate(${angle}deg)`;
                isMovingRight = !isMovingRight; // Inverte a direção para o próximo ciclo
            } 
            
            // Para compassos com número ímpar de tempos (ex: 3/4), a lógica de inversão precisa de ajustes finos
            // A animação visual precisa ser ligeiramente simplificada aqui para funcionar em todos os casos:
            
            // A cada batida principal, movemos a agulha de forma sequencial
            // 1ª Batida: Esquerda, 2ª Batida: Centro, 3ª Batida: Direita, 4ª Batida: Centro (e repete)
            
            let angle;
            // O valor máximo do ângulo de oscilação (aumenta com o BPM para parecer mais rápido)
            const maxAngle = 20 + (bpm / 240) * 10; 
            
            // Normaliza a batida principal dentro de um ciclo de 4 movimentos (L, C, D, C)
            const normalizedBeat = (beatIndex - 1) % 4; 

            switch (normalizedBeat) {
                case 0: // Primeira batida (Lado Esquerdo)
                    angle = -maxAngle;
                    break;
                case 1: // Segunda batida (Centro)
                    angle = 0;
                    break;
                case 2: // Terceira batida (Lado Direito)
                    angle = maxAngle;
                    break;
                case 3: // Quarta batida (Centro)
                    angle = 0;
                    break;
                default:
                    angle = 0;
            }

            // Garante que o pêndulo atinja o centro a cada ímpar se o total de batidas for par (4/4, 2/4)
            if (beatsPerMeasure % 2 === 0) {
                 if (beatIndex === beatsPerMeasure / 2 || beatIndex === beatsPerMeasure) {
                     // Ajusta o pêndulo para o centro ou extremo dependendo do número de tempos
                 }
            }


            // Lógica mais simples (Extremo L -> Extremo D)
            const isFirstClick = clickIndex === 1;
            const isMiddleClick = Math.floor(totalBeats / 2) + 1;
            const isLastClick = clickIndex === totalBeats;

            // Transição principal
            if (totalBeats > 1) {
                const step = (clickIndex - 1) / (totalBeats - 1); // 0.0 a 1.0
                angle = -maxAngle + (step * (2 * maxAngle)); // -maxAngle (0%) até +maxAngle (100%)
            } else {
                angle = 0; // Se houver apenas 1 clique por tempo
            }

            pendulumEl.style.transform = `translateX(-50%) rotate(${angle}deg)`;

        }

        function scheduleAnimation(time, clickIndex) {
            const delay = Math.max(0, time - audioContext.currentTime);
            // Sincroniza a função de movimento do pêndulo com o tempo exato do som
            setTimeout(() => {
                movePendulum(clickIndex);
            }, delay * 1000); 
        }


        // --- Funções de UI e Opções ---

        function generateBeatIndicators() {
            beatIndicatorsContainer.innerHTML = ''; 
            // Os indicadores visuais representam as BATIDAS PRINCIPAIS (beatsPerMeasure)
            for (let i = 0; i < beatsPerMeasure; i++) {
                const dot = document.createElement('div');
                dot.classList.add('beat-indicator');
                beatIndicatorsContainer.appendChild(dot);
            }
        }

        function updateMetronomeConfig(newBeats, newSubdivision) {
            beatsPerMeasure = newBeats;
            subdivisionFactor = newSubdivision;
            totalBeats = beatsPerMeasure * subdivisionFactor;
            
            generateBeatIndicators();
            
            if (isRunning) {
                // Se estiver rodando, reinicia o ciclo
                stopTimer();
                currentClick = 0;
                togglePlayStop(); // Inicia novamente
            }
        }
        
        function togglePlayStop() {
            if (!audioContext) {
                audioContext = new AudioContext();
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (isRunning) {
                isRunning = false;
                stopTimer();
                playStopBtn.textContent = 'INICIAR';
                playStopBtn.classList.remove('playing');
            } else {
                isRunning = true;
                currentClick = 0;
                nextNoteTime = audioContext.currentTime; 

                startTimer();
                playStopBtn.textContent = 'PARAR';
                playStopBtn.classList.add('playing');
            }
        }

        function updateBPM(newBPM) {
            bpm = Math.max(40, Math.min(240, newBPM));
            bpmDisplay.textContent = bpm;
            bpmSlider.value = bpm;
            
            // Ao mudar o BPM, a agulha fica mais/menos rápida por CSS 'transition' e o novo 'angle' no movePendulum.
        }
        
        // --- Event Listeners ---

        playStopBtn.addEventListener('click', togglePlayStop);
        
        bpmSlider.addEventListener('input', (e) => {
            updateBPM(parseInt(e.target.value));
        });
        
        document.getElementById('increaseBPM').addEventListener('click', () => updateBPM(bpm + 1));
        document.getElementById('decreaseBPM').addEventListener('click', () => updateBPM(bpm - 1));

        timeSignatureControls.addEventListener('click', (e) => {
            const button = e.target.closest('.time-sig-btn');
            if (button) {
                document.querySelectorAll('.time-sig-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                const newBeats = parseInt(button.dataset.beats);
                // subdivisionFactor é 1 por padrão para compassos simples (4/4, 3/4)
                const newSub = parseInt(button.dataset.subdivision || 1); 

                updateMetronomeConfig(newBeats, newSub);
            }
        });


        // --- Inicialização ---

        updateBPM(120);
        generateBeatIndicators();
        // Move a agulha para o centro na inicialização
        pendulumEl.style.transform = 'translateX(-50%) rotate(0deg)';

    </script>
</body>
</html>
