import React, { useState, useRef, useEffect } from 'react';
import { Download, Upload, Move, Palette, Type, Box, Trash2, Copy, Eye, Code } from 'lucide-react';

export default function VisualCSSEditor() {
  const [html, setHtml] = useState('<div class="container">\n  <h1>T√≠tulo</h1>\n  <p class="text">Par√°grafo de exemplo</p>\n  <button class="btn">Bot√£o</button>\n</div>');
  const [css, setCss] = useState(`.container {
  padding: 20px;
  background: #f0f0f0;
  border-radius: 8px;
}

h1 {
  color: #333;
  font-size: 32px;
  margin-bottom: 10px;
}

.text {
  color: #666;
  font-size: 16px;
  margin-bottom: 20px;
}

.btn {
  background: #4CAF50;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}`);
  
  const [selectedElement, setSelectedElement] = useState(null);
  const [viewMode, setViewMode] = useState('split'); // 'visual', 'code', 'split'
  const iframeRef = useRef(null);
  const [elementStyles, setElementStyles] = useState({});

  // Atualiza o iframe com HTML + CSS
  useEffect(() => {
    if (iframeRef.current) {
      const doc = iframeRef.current.contentDocument;
      const fullHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { padding: 20px; font-family: Arial, sans-serif; }
            .selected-element { outline: 3px solid #2196F3 !important; outline-offset: 2px; }
            ${css}
          </style>
        </head>
        <body>${html}</body>
        </html>
      `;
      doc.open();
      doc.write(fullHTML);
      doc.close();

      // Adiciona evento de clique nos elementos
      doc.body.addEventListener('click', handleElementClick);
    }
  }, [html, css]);

  // Seleciona elemento ao clicar
  const handleElementClick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    const doc = iframeRef.current.contentDocument;
    doc.querySelectorAll('.selected-element').forEach(el => {
      el.classList.remove('selected-element');
    });
    
    e.target.classList.add('selected-element');
    
    const tagName = e.target.tagName.toLowerCase();
    const className = e.target.className.replace('selected-element', '').trim();
    const id = e.target.id;
    
    let selector = tagName;
    if (id) selector = `#${id}`;
    else if (className) selector = `.${className.split(' ')[0]}`;
    
    setSelectedElement({
      selector,
      element: e.target
    });
    
    // Extrai estilos computados
    const computedStyles = window.getComputedStyle(e.target);
    setElementStyles({
      background: rgbToHex(computedStyles.backgroundColor),
      color: rgbToHex(computedStyles.color),
      fontSize: parseInt(computedStyles.fontSize),
      padding: parseInt(computedStyles.padding),
      margin: parseInt(computedStyles.margin),
      borderRadius: parseInt(computedStyles.borderRadius),
      width: computedStyles.width,
      height: computedStyles.height,
      display: computedStyles.display,
      textAlign: computedStyles.textAlign,
      fontWeight: computedStyles.fontWeight
    });
  };

  // Converte RGB para HEX
  const rgbToHex = (rgb) => {
    if (!rgb || rgb === 'rgba(0, 0, 0, 0)') return '#ffffff';
    const match = rgb.match(/\d+/g);
    if (!match) return '#000000';
    return '#' + match.slice(0, 3).map(x => {
      const hex = parseInt(x).toString(16);
      return hex.length === 1 ? '0' + hex : hex;
    }).join('');
  };

  // Atualiza CSS quando propriedade muda
  const updateCSS = (property, value) => {
    if (!selectedElement) return;
    
    const selector = selectedElement.selector;
    const cssLines = css.split('\n');
    let updated = false;
    let inBlock = false;
    let blockStart = -1;
    
    // Procura o seletor no CSS
    for (let i = 0; i < cssLines.length; i++) {
      if (cssLines[i].includes(selector + ' {')) {
        inBlock = true;
        blockStart = i;
        continue;
      }
      
      if (inBlock && cssLines[i].includes('}')) {
        // Adiciona propriedade antes do fechamento
        if (!updated) {
          cssLines.splice(i, 0, `  ${property}: ${value};`);
        }
        break;
      }
      
      if (inBlock && cssLines[i].includes(property + ':')) {
        cssLines[i] = `  ${property}: ${value};`;
        updated = true;
      }
    }
    
    // Se seletor n√£o existe, cria novo bloco
    if (blockStart === -1) {
      cssLines.push('');
      cssLines.push(`${selector} {`);
      cssLines.push(`  ${property}: ${value};`);
      cssLines.push(`}`);
    }
    
    setCss(cssLines.join('\n'));
    
    // Atualiza estado local
    setElementStyles(prev => ({
      ...prev,
      [property]: value
    }));
  };

  // Importa arquivos
  const handleImportHTML = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => setHtml(event.target.result);
      reader.readAsText(file);
    }
  };

  const handleImportCSS = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => setCss(event.target.result);
      reader.readAsText(file);
    }
  };

  // Exporta CSS
  const downloadCSS = () => {
    const blob = new Blob([css], { type: 'text/css' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'styles.css';
    a.click();
  };

  // Exporta HTML
  const downloadHTML = () => {
    const fullHTML = `<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
${html}
</body>
</html>`;
    const blob = new Blob([fullHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'index.html';
    a.click();
  };

  return (
    <div className="flex flex-col h-screen bg-gray-900 text-white">
      {/* Header */}
      <div className="bg-gray-800 p-4 border-b border-gray-700">
        <div className="flex items-center justify-between flex-wrap gap-3">
          <h1 className="text-2xl font-bold flex items-center gap-2">
            <Palette className="w-6 h-6" />
            Editor Visual de CSS
          </h1>
          
          <div className="flex gap-2 flex-wrap">
            <label className="px-4 py-2 bg-blue-600 rounded cursor-pointer hover:bg-blue-700 flex items-center gap-2">
              <Upload className="w-4 h-4" />
              HTML
              <input type="file" accept=".html" onChange={handleImportHTML} className="hidden" />
            </label>
            
            <label className="px-4 py-2 bg-purple-600 rounded cursor-pointer hover:bg-purple-700 flex items-center gap-2">
              <Upload className="w-4 h-4" />
              CSS
              <input type="file" accept=".css" onChange={handleImportCSS} className="hidden" />
            </label>
            
            <button onClick={downloadHTML} className="px-4 py-2 bg-green-600 rounded hover:bg-green-700 flex items-center gap-2">
              <Download className="w-4 h-4" />
              HTML
            </button>
            
            <button onClick={downloadCSS} className="px-4 py-2 bg-green-600 rounded hover:bg-green-700 flex items-center gap-2">
              <Download className="w-4 h-4" />
              CSS
            </button>
          </div>
        </div>
        
        {/* View Mode Toggle */}
        <div className="flex gap-2 mt-3">
          <button 
            onClick={() => setViewMode('visual')}
            className={`px-3 py-1 rounded ${viewMode === 'visual' ? 'bg-blue-600' : 'bg-gray-700'}`}
          >
            <Eye className="w-4 h-4 inline mr-1" />
            Visual
          </button>
          <button 
            onClick={() => setViewMode('code')}
            className={`px-3 py-1 rounded ${viewMode === 'code' ? 'bg-blue-600' : 'bg-gray-700'}`}
          >
            <Code className="w-4 h-4 inline mr-1" />
            C√≥digo
          </button>
          <button 
            onClick={() => setViewMode('split')}
            className={`px-3 py-1 rounded ${viewMode === 'split' ? 'bg-blue-600' : 'bg-gray-700'}`}
          >
            <Box className="w-4 h-4 inline mr-1" />
            Split
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 flex overflow-hidden">
        {/* Visual Editor */}
        {(viewMode === 'visual' || viewMode === 'split') && (
          <div className={`${viewMode === 'split' ? 'w-1/2' : 'w-full'} p-4 overflow-auto border-r border-gray-700`}>
            <div className="bg-white rounded-lg overflow-hidden" style={{ minHeight: '500px' }}>
              <iframe
                ref={iframeRef}
                className="w-full h-full"
                style={{ minHeight: '500px', border: 'none' }}
                title="preview"
              />
            </div>
          </div>
        )}

        {/* Code Editor */}
        {(viewMode === 'code' || viewMode === 'split') && (
          <div className={`${viewMode === 'split' ? 'w-1/2' : 'w-full'} flex flex-col`}>
            <div className="flex-1 p-4 overflow-auto">
              <h3 className="text-lg font-bold mb-2">HTML</h3>
              <textarea
                value={html}
                onChange={(e) => setHtml(e.target.value)}
                className="w-full h-48 p-3 bg-gray-800 text-green-400 font-mono text-sm rounded border border-gray-700"
                spellCheck="false"
              />
              
              <h3 className="text-lg font-bold mb-2 mt-4">CSS</h3>
              <textarea
                value={css}
                onChange={(e) => setCss(e.target.value)}
                className="w-full flex-1 p-3 bg-gray-800 text-blue-400 font-mono text-sm rounded border border-gray-700"
                style={{ minHeight: '300px' }}
                spellCheck="false"
              />
            </div>
          </div>
        )}
      </div>

      {/* Property Panel */}
      {selectedElement && (
        <div className="bg-gray-800 border-t border-gray-700 p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-lg font-bold">
              Editando: <span className="text-blue-400">{selectedElement.selector}</span>
            </h3>
            <button 
              onClick={() => setSelectedElement(null)}
              className="text-gray-400 hover:text-white"
            >
              ‚úï
            </button>
          </div>
          
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <label className="block text-sm mb-1">Cor de Fundo</label>
              <input
                type="color"
                value={elementStyles.background || '#ffffff'}
                onChange={(e) => updateCSS('background', e.target.value)}
                className="w-full h-10 rounded cursor-pointer"
              />
            </div>
            
            <div>
              <label className="block text-sm mb-1">Cor do Texto</label>
              <input
                type="color"
                value={elementStyles.color || '#000000'}
                onChange={(e) => updateCSS('color', e.target.value)}
                className="w-full h-10 rounded cursor-pointer"
              />
            </div>
            
            <div>
              <label className="block text-sm mb-1">Tamanho da Fonte</label>
              <input
                type="number"
                value={elementStyles.fontSize || 16}
                onChange={(e) => updateCSS('font-size', e.target.value + 'px')}
                className="w-full p-2 bg-gray-700 rounded"
              />
            </div>
            
            <div>
              <label className="block text-sm mb-1">Padding</label>
              <input
                type="number"
                value={elementStyles.padding || 0}
                onChange={(e) => updateCSS('padding', e.target.value + 'px')}
                className="w-full p-2 bg-gray-700 rounded"
              />
            </div>
            
            <div>
              <label className="block text-sm mb-1">Margin</label>
              <input
                type="number"
                value={elementStyles.margin || 0}
                onChange={(e) => updateCSS('margin', e.target.value + 'px')}
                className="w-full p-2 bg-gray-700 rounded"
              />
            </div>
            
            <div>
              <label className="block text-sm mb-1">Border Radius</label>
              <input
                type="number"
                value={elementStyles.borderRadius || 0}
                onChange={(e) => updateCSS('border-radius', e.target.value + 'px')}
                className="w-full p-2 bg-gray-700 rounded"
              />
            </div>
            
            <div>
              <label className="block text-sm mb-1">Alinhamento</label>
              <select
                value={elementStyles.textAlign || 'left'}
                onChange={(e) => updateCSS('text-align', e.target.value)}
                className="w-full p-2 bg-gray-700 rounded"
              >
                <option value="left">Esquerda</option>
                <option value="center">Centro</option>
                <option value="right">Direita</option>
                <option value="justify">Justificado</option>
              </select>
            </div>
            
            <div>
              <label className="block text-sm mb-1">Peso da Fonte</label>
              <select
                value={elementStyles.fontWeight || 'normal'}
                onChange={(e) => updateCSS('font-weight', e.target.value)}
                className="w-full p-2 bg-gray-700 rounded"
              >
                <option value="normal">Normal</option>
                <option value="bold">Negrito</option>
                <option value="lighter">Leve</option>
              </select>
            </div>
          </div>
        </div>
      )}

      {/* Instructions */}
      {!selectedElement && (
        <div className="bg-gray-800 border-t border-gray-700 p-4 text-center text-gray-400">
          üí° Clique em qualquer elemento na visualiza√ß√£o para edit√°-lo visualmente
        </div>
      )}
    </div>
  );
}
